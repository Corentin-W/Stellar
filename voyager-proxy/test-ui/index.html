<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî≠ Voyager Proxy - Interface de Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üî≠ Voyager Proxy - Interface de Test</h1>
            <div class="connection-status">
                <span id="apiStatus" class="status-badge disconnected">API: D√©connect√©</span>
                <span id="wsStatus" class="status-badge disconnected">WebSocket: D√©connect√©</span>
                <span id="voyagerStatus" class="status-badge disconnected">Voyager: D√©connect√©</span>
            </div>
        </header>

        <!-- Configuration -->
        <section class="config-section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="config-form">
                <div class="form-group">
                    <label>URL du Proxy</label>
                    <input type="text" id="proxyUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="apiKey" placeholder="Votre API Key (si configur√©e)">
                </div>
                <div class="form-actions">
                    <button onclick="testConnection()" class="btn btn-primary">üîå Tester Connexion</button>
                    <button onclick="connectWebSocket()" class="btn btn-secondary">üîå Connecter WebSocket</button>
                    <button onclick="disconnectWebSocket()" class="btn btn-danger">‚ùå D√©connecter WebSocket</button>
                </div>
            </div>
        </section>

        <!-- API Tests -->
        <section class="api-section">
            <h2>üì° Tests API REST</h2>
            <div class="section-help">
                <strong>√Ä quoi √ßa sert :</strong> L'API REST permet √† Laravel de communiquer avec le proxy via HTTP.
                C'est l'interface principale pour envoyer des commandes et r√©cup√©rer l'√©tat du syst√®me.
            </div>
            <div class="api-grid">
                <div class="api-card">
                    <h3>Health Check</h3>
                    <div class="command-help">
                        <strong>But :</strong> V√©rifier que le proxy fonctionne<br>
                        <strong>Utilisation :</strong> Monitoring, tests de sant√©<br>
                        <strong>R√©sultat :</strong> Status OK + uptime + version
                    </div>
                    <button onclick="apiHealthCheck()" class="btn btn-sm">Test</button>
                    <pre id="result-health" class="result"></pre>
                </div>
                <div class="api-card">
                    <h3>Connection Status</h3>
                    <div class="command-help">
                        <strong>But :</strong> V√©rifier la connexion Voyager<br>
                        <strong>Utilisation :</strong> Savoir si Voyager est joignable<br>
                        <strong>R√©sultat :</strong> connected: true/false + timestamp
                    </div>
                    <button onclick="apiConnectionStatus()" class="btn btn-sm">Test</button>
                    <pre id="result-connection" class="result"></pre>
                </div>
                <div class="api-card">
                    <h3>Dashboard State</h3>
                    <div class="command-help">
                        <strong>But :</strong> R√©cup√©rer l'√©tat complet de l'observatoire<br>
                        <strong>Utilisation :</strong> Afficher temp√©rature, position, status √©quipements<br>
                        <strong>R√©sultat :</strong> ControlData complet (cam√©ra, monture, focuser, etc.)
                    </div>
                    <button onclick="apiDashboardState()" class="btn btn-sm">Test</button>
                    <pre id="result-dashboard" class="result"></pre>
                </div>
                <div class="api-card">
                    <h3>Enable Dashboard Mode</h3>
                    <div class="command-help">
                        <strong>But :</strong> Activer les mises √† jour automatiques Voyager<br>
                        <strong>Utilisation :</strong> √Ä appeler au d√©but de chaque session utilisateur<br>
                        <strong>Effet :</strong> Voyager envoie ControlData toutes les 2 secondes
                    </div>
                    <button onclick="apiEnableDashboard()" class="btn btn-sm">Activer</button>
                    <pre id="result-enable-dashboard" class="result"></pre>
                </div>
            </div>
        </section>

        <!-- Control Commands -->
        <section class="control-section">
            <h2>üéÆ Commandes de Contr√¥le</h2>
            <div class="section-help">
                <strong>√Ä quoi √ßa sert :</strong> Ces commandes permettent de piloter directement les √©quipements de l'observatoire.
                Elles envoient des ordres JSON-RPC √† Voyager via le proxy. R√©sultat attendu : RemoteActionResult avec code de succ√®s/erreur.
            </div>
            <div class="control-grid">
                <div class="control-card">
                    <h3>‚õî Abort Session</h3>
                    <div class="command-help">
                        <strong>But :</strong> Arr√™ter IMM√âDIATEMENT toute action en cours<br>
                        <strong>Quand :</strong> L'utilisateur clique "Stop" pendant une exposition, mouvement, autofocus...<br>
                        <strong>Effet :</strong> Stop exposition cam√©ra, arr√™t mouvement monture, abandon autofocus, etc.<br>
                        <strong>R√©sultat attendu :</strong> Signal 503 (Action Stopped) via WebSocket
                    </div>
                    <button onclick="cmdAbort()" class="btn btn-danger">Arr√™ter</button>
                    <pre id="result-abort" class="result"></pre>
                </div>
                <div class="control-card">
                    <h3>üéØ Toggle Target</h3>
                    <div class="command-help">
                        <strong>But :</strong> Activer/D√©sactiver une cible dans la s√©quence RoboTarget<br>
                        <strong>Quand :</strong> L'utilisateur veut mettre en pause ou reprendre une cible automatis√©e<br>
                        <strong>Param√®tre :</strong> GUID de la cible (r√©cup√©r√© via GET /robotarget/targets)<br>
                        <strong>Effet :</strong> La cible devient active (sera photographi√©e) ou inactive (ignor√©e)<br>
                        <strong>R√©sultat attendu :</strong> RemoteActionResult avec succ√®s
                    </div>
                    <div class="form-inline">
                        <input type="text" id="targetGuid" placeholder="Target GUID" class="input-sm">
                        <label><input type="checkbox" id="activateTarget"> Activer</label>
                    </div>
                    <button onclick="cmdToggleTarget()" class="btn btn-primary">Toggle</button>
                    <pre id="result-toggle" class="result"></pre>
                </div>
                <div class="control-card">
                    <h3>üì∏ Take Shot</h3>
                    <div class="command-help">
                        <strong>But :</strong> Prendre une photo avec la cam√©ra<br>
                        <strong>Quand :</strong> L'utilisateur demande une exposition manuelle<br>
                        <strong>Param√®tres :</strong><br>
                        - Exposure : dur√©e en secondes (ex: 1, 5, 60, 300)<br>
                        - Binning : 1 (qualit√© max) ou 2/3/4 (fichiers plus l√©gers)<br>
                        - Filter : 0 (luminance) ou 1-7 selon la roue √† filtres<br>
                        <strong>Effet :</strong> D√©clenche exposition ‚Üí √©v√©nements shotRunning (progression) ‚Üí newFITReady (termin√©)<br>
                        <strong>R√©sultat attendu :</strong> RemoteActionResult + shotRunning + newFITReady
                    </div>
                    <div class="form-inline">
                        <input type="number" id="exposure" placeholder="Expo (s)" class="input-sm" value="1">
                        <input type="number" id="binning" placeholder="Bin" class="input-sm" value="1">
                        <input type="number" id="filter" placeholder="Filtre" class="input-sm" value="0">
                    </div>
                    <button onclick="cmdTakeShot()" class="btn btn-primary">Prendre Photo</button>
                    <pre id="result-shot" class="result"></pre>
                </div>
                <div class="control-card">
                    <h3>üî≠ Telescope</h3>
                    <div class="command-help">
                        <strong>Park :</strong> Remettre la monture en position de repos (s√©curit√©)<br>
                        <strong>Unpark :</strong> Sortir du mode parking (permet mouvement)<br>
                        <strong>Start Tracking :</strong> Activer suivi sid√©ral (compenser rotation Terre)<br>
                        <strong>Stop Tracking :</strong> Arr√™ter le suivi (monture fixe)<br>
                        <strong>Quand :</strong> Avant/apr√®s session, pour s√©curiser ou activer le t√©lescope<br>
                        <strong>R√©sultat attendu :</strong> RemoteActionResult avec code 200 (OK)
                    </div>
                    <button onclick="cmdPark()" class="btn btn-sm">Park</button>
                    <button onclick="cmdUnpark()" class="btn btn-sm">Unpark</button>
                    <button onclick="cmdStartTracking()" class="btn btn-sm">Start Tracking</button>
                    <button onclick="cmdStopTracking()" class="btn btn-sm">Stop Tracking</button>
                    <pre id="result-telescope" class="result"></pre>
                </div>
            </div>
        </section>

        <!-- Real-time Dashboard -->
        <section class="dashboard-section">
            <h2>üìä Dashboard Temps R√©el (WebSocket)</h2>
            <div class="dashboard-grid">
                <!-- Voyager Status -->
                <div class="dashboard-card">
                    <h3>Voyager</h3>
                    <div class="stat">
                        <span class="label">Statut:</span>
                        <span id="voy-status" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Setup:</span>
                        <span id="voy-setup" class="value">-</span>
                    </div>
                </div>

                <!-- Camera -->
                <div class="dashboard-card">
                    <h3>üì∑ Cam√©ra</h3>
                    <div class="stat">
                        <span class="label">Connect√©e:</span>
                        <span id="cam-conn" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Temp√©rature:</span>
                        <span id="cam-temp" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Consigne:</span>
                        <span id="cam-setpoint" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Puissance:</span>
                        <span id="cam-power" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Cooling:</span>
                        <span id="cam-cooling" class="value">-</span>
                    </div>
                </div>

                <!-- Mount -->
                <div class="dashboard-card">
                    <h3>üî≠ Monture</h3>
                    <div class="stat">
                        <span class="label">Connect√©e:</span>
                        <span id="mnt-conn" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Park√©e:</span>
                        <span id="mnt-park" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">RA:</span>
                        <span id="mnt-ra" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">DEC:</span>
                        <span id="mnt-dec" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Tracking:</span>
                        <span id="mnt-track" class="value">-</span>
                    </div>
                </div>

                <!-- Focuser -->
                <div class="dashboard-card">
                    <h3>üéØ Focuser</h3>
                    <div class="stat">
                        <span class="label">Connect√©:</span>
                        <span id="foc-conn" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Position:</span>
                        <span id="foc-pos" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Temp√©rature:</span>
                        <span id="foc-temp" class="value">-</span>
                    </div>
                </div>

                <!-- Sequence -->
                <div class="dashboard-card">
                    <h3>üìã S√©quence</h3>
                    <div class="stat">
                        <span class="label">Nom:</span>
                        <span id="seq-name" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">Restant:</span>
                        <span id="seq-remain" class="value">-</span>
                    </div>
                </div>

                <!-- Guiding -->
                <div class="dashboard-card">
                    <h3>üéØ Guidage</h3>
                    <div class="stat">
                        <span class="label">Statut:</span>
                        <span id="guide-status" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">RMS X:</span>
                        <span id="guide-x" class="value">-</span>
                    </div>
                    <div class="stat">
                        <span class="label">RMS Y:</span>
                        <span id="guide-y" class="value">-</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- WebSocket Events Console -->
        <section class="events-section">
            <h2>üì° √âv√©nements WebSocket</h2>
            <div class="events-controls">
                <button onclick="clearEvents()" class="btn btn-sm">üóëÔ∏è Effacer</button>
                <label>
                    <input type="checkbox" id="autoScroll" checked> Auto-scroll
                </label>
                <label>
                    <input type="checkbox" id="showControlData"> Afficher ControlData (verbose)
                </label>
            </div>
            <div id="events" class="events-console"></div>
        </section>

        <!-- Logs Console -->
        <section class="logs-section">
            <h2>üìù Logs</h2>
            <div class="logs-controls">
                <button onclick="clearLogs()" class="btn btn-sm">üóëÔ∏è Effacer</button>
            </div>
            <div id="logs" class="logs-console"></div>
        </section>
    </div>

    <script src="app.js"></script>
</body>
</html>
